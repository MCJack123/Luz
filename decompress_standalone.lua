local all_frequencies = {{0,4393,},{1,780,},{2,569,},{3,369,},{4,369,},{5,161,},{6,151,},{7,171,},{8,184,},{9,112,},{10,192,},{11,57,},{12,90,},{13,73,},{14,67,},{15,106,},{16,136,},{17,44,},{18,44,},{19,49,},{20,57,},{21,38,},{22,40,},{23,27,},{24,59,},{25,63,},{26,29,},{27,37,},{28,34,},{29,32,},{30,41,},{31,54,},{32,5908,},{33,293,},{34,267,},{35,209,},{36,159,},{37,556,},{38,80,},{39,264,},{40,561,},{41,487,},{42,200,},{43,251,},{44,503,},{45,645,},{46,1150,},{47,538,},{48,659,},{49,1148,},{50,1287,},{51,845,},{52,595,},{53,377,},{54,393,},{55,254,},{56,324,},{57,212,},{58,478,},{59,101,},{60,236,},{61,264,},{62,253,},{63,149,},{64,1584,},{65,1167,},{66,724,},{67,1769,},{68,980,},{69,1210,},{70,833,},{71,583,},{72,557,},{73,1219,},{74,133,},{75,299,},{76,913,},{77,675,},{78,937,},{79,963,},{80,1126,},{81,103,},{82,1089,},{83,1936,},{84,1684,},{85,537,},{86,460,},{87,514,},{88,291,},{89,404,},{90,201,},{91,382,},{92,446,},{93,375,},{94,193,},{95,4813,},{96,67,},{97,12151,},{98,4183,},{99,6791,},{100,6267,},{101,18467,},{102,3853,},{103,3808,},{104,3801,},{105,11272,},{106,650,},{107,2133,},{108,9140,},{109,4897,},{110,10473,},{111,10616,},{112,5723,},{113,537,},{114,12505,},{115,11023,},{116,13839,},{117,6176,},{118,2584,},{119,2166,},{120,2296,},{121,3050,},{122,653,},{123,75,},{124,51,},{125,75,},{126,83,},{127,36,},{128,1265,},{129,23,},{130,16,},{131,23,},{132,19,},{133,19,},{134,8,},{135,29,},{136,11,},{137,8,},{138,1,},{139,9,},{140,9,},{141,15,},{142,5,},{143,10,},{144,10,},{145,9,},{146,4,},{147,18,},{148,9,},{149,18,},{150,3,},{151,8,},{152,8,},{153,46,},{154,11,},{155,13,},{156,10,},{157,4,},{158,7,},{159,8,},{160,62,},{161,7,},{162,11,},{163,19,},{164,6,},{165,12,},{166,3,},{167,21,},{168,12,},{169,13,},{170,5,},{171,11,},{172,12,},{173,7,},{174,8,},{175,10,},{176,19,},{177,7,},{178,9,},{179,7,},{180,11,},{181,13,},{182,6,},{183,8,},{184,6,},{185,15,},{186,5,},{187,8,},{188,12,},{189,19,},{190,11,},{191,8,},{192,1044,},{193,7,},{194,9,},{195,7,},{196,10,},{197,7,},{198,8,},{199,6,},{200,8,},{201,10,},{202,4,},{203,5,},{204,21,},{205,61,},{206,14,},{207,4,},{208,12,},{209,7,},{210,7,},{211,13,},{212,9,},{213,12,},{214,9,},{215,8,},{216,3,},{217,5,},{218,38,},{219,7,},{220,15,},{221,6,},{222,8,},{223,126,},{224,16,},{225,6,},{226,7,},{227,4,},{228,4,},{229,8,},{230,7,},{231,4,},{232,6,},{233,10,},{234,7,},{235,5,},{236,10,},{237,8,},{238,8,},{239,8,},{240,11,},{241,7,},{242,9,},{243,4,},{244,8,},{245,11,},{246,5,},{247,8,},{248,8,},{249,8,},{250,6,},{251,7,},{252,4,},{253,12,},{254,4,},{255,213,},{":end",1,},{":repeat0",39840,},{":repeat1",22561,},{":repeat2",16416,},{":repeat3",13652,},{":repeat4",21493,},{":repeat5",13984,},{":repeat6",16902,},{":repeat7",9501,},{":repeat8",8965,},{":repeat9",3699,},{":repeat10",2810,},{":repeat11",1165,},{":repeat12",996,},{":repeat13",1062,},{"\"\"",452,},{"\"boolean\"",53,},{"\"function\"",73,},{"\"nil\"",66,},{"\"number\"",131,},{"\"r\"",68,},{"\"string\"",166,},{"\"table\"",146,},{"\"w\"",55,},{"#",645,},{"%",269,},{"(",6864,},{")",10582,},{"*",595,},{"+",1588,},{",",8052,},{"-",1283,},{"-1",173,},{".",2860,},{"..",1233,},{"...",406,},{"/",467,},{"0",602,},{"1",583,},{"2",536,},{":",753,},{":name",15588,},{":number",2836,},{":string",4111,},{";",288,},{"<",541,},{"<=",218,},{"=",7681,},{"==",2170,},{">",617,},{">=",309,},{"[",1878,},{"]",2355,},{"^",82,},{"_",208,},{"_ENV",34,},{"_G",68,},{"__call",30,},{"__index",79,},{"__newindex",25,},{"and",1329,},{"bit32",72,},{"break",212,},{"close",130,},{"coroutine",58,},{"debug",45,},{"do",1619,},{"else",1401,},{"elseif",662,},{"end",6344,},{"error",305,},{"false",645,},{"find",131,},{"for",1011,},{"function",1356,},{"getmetatable",62,},{"gsub",98,},{"if",3099,},{"in",473,},{"io",47,},{"ipairs",164,},{"load",39,},{"local",4254,},{"match",87,},{"math",230,},{"nil",1483,},{"not",680,},{"open",107,},{"or",1380,},{"os",187,},{"package",25,},{"pairs",215,},{"pcall",70,},{"print",174,},{"read",85,},{"repeat",68,},{"require",93,},{"return",2652,},{"select",66,},{"self",203,},{"setmetatable",151,},{"string",277,},{"sub",216,},{"table",272,},{"then",3613,},{"tonumber",90,},{"tostring",109,},{"true",866,},{"type",294,},{"unpack",129,},{"until",58,},{"while",419,},{"write",160,},{"{",1690,},{"}",1860,},{"~=",1050,},R=19}
local bit32_band, bit32_rshift, bit32_lshift, bit32_extract, math_frexp, math_max, math_floor, string_match = bit32.band, bit32.rshift, bit32.lshift, bit32.extract, math.frexp, math.max, math.floor, string.match
local function log2(n) local _, r = math_frexp(n) return r-1 end
local tokenlut, rlemap = {}, {2, 6, 22, 86, 342, 1366, 5462}
for i, v in ipairs(all_frequencies) do tokenlut[i] = v[1] end

local function makeReader(str)
    local partial, bits, pos = 0, 0, 1
    local function readbits(n)
        if n == 0 then return 0 end
        while bits < n do partial, pos, bits = bit32_lshift(partial, 8) + str:byte(pos), pos + 1, bits + 8 end
        local retval = bit32_band(bit32_rshift(partial, bits-n), 2^n-1)
        bits = bits - n
        return retval
    end
    return readbits
end

local function generateDecodeTable(Ls)
    local R = Ls.R
    local L = 2^R
    local X, step = 0, 0.625 * L + 3
    local decodingTable, next, symbol = {R = R}, {}, {}
    for _, p in ipairs(Ls) do
        next[p[1]] = p[2]
        for _ = 1, p[2] do symbol[X], X = p[1], (X + step) % L end
    end
    for X = 0, L - 1 do
        local s = symbol[X]
        local t = {symbol = s, nbBits = R - log2(next[s])}
        t.newX, decodingTable[X], next[s] = bit32_lshift(next[s], t.nbBits) - L, t, next[s] + 1
    end
    return decodingTable
end

local function ansdecode(readbits, nsym, decodingTable)
    local X, retval = readbits(decodingTable.R), {}
    for i = 1, nsym do
        local t = decodingTable[X]
        retval[#retval+1], X = t.symbol, t.newX + readbits(t.nbBits)
    end
    return retval
end

local function blockdecompress(readbits, nBits, defaultLs, symbolMap)
    local combined, lzcodes = {}, {}
    repeat
        local retval = {}
        if readbits(1) == 0 then
            local bits, nEntries = readbits(3)
            if bits == 0 then nEntries = 1
            else nEntries = readbits(bits * 2) + rlemap[bits] end
            for _ = 1, nEntries do
                local n, c = readbits(4), readbits(nBits)
                for _ = 0, n do retval[#retval+1] = symbolMap[c] end
            end
        else
            local Ls
            if readbits(1) == 1 then
                if readbits(1) == 1 then
                    local R, maxL, numEnt = readbits(4) + 5, readbits(4) + 5, readbits(nBits)
                    Ls = {R = R}
                    local totalL, lastn = 2^R - 1, -1
                    for _ = 1, numEnt do
                        local _, e, sym = math_frexp(totalL)
                        local nbits, n = math.min(e, maxL)
                        if readbits(1) == 1 then sym = readbits(nBits)
                        else sym = lastn + 1 end
                        if readbits(1) == 1 then n = readbits(nbits)
                        else n = readbits(math.floor(nbits/2)) end
                        Ls[#Ls+1], totalL, lastn = {symbolMap[sym], n}, totalL - n, sym
                    end
                else
                    local bitlen, bitidx, maxs = {}, 0, readbits(9)
                    while bitidx <= maxs do
                        if readbits(1) == 1 then
                            local n, c = readbits(3) + 2, readbits(5)
                            for _ = 1, n do
                                if c > 0 then bitlen[#bitlen+1] = {symbolMap[bitidx], 2^(R-c)} end
                                bitidx = bitidx + 1
                            end
                        else
                            local l = readbits(5)
                            if l > 0 then bitlen[#bitlen+1] = {symbolMap[bitidx], 2^(R-l)} end
                            bitidx = bitidx + 1
                        end
                    end
                    Ls = bitlen
                end
            else
                if not defaultLs then error("invalid file (dictionary required but not supplied)", 2) end
                Ls = defaultLs
            end
            local decodingTable, anssyms = generateDecodeTable(Ls), readbits(18)
            local ansdata, codetree = ansdecode(readbits, anssyms, decodingTable)
            if readbits(1) == 1 then
                local bitlen, bitidx = {}, 0
                while bitidx < 30 do
                    if readbits(1) == 1 then
                        local n, c = readbits(3) + 2, readbits(4)
                        for _ = 1, n do
                            if c > 0 then bitlen[#bitlen+1] = {s = bitidx, l = c} end
                            bitidx = bitidx + 1
                        end
                    else
                        local l = readbits(4)
                        if l > 0 then bitlen[#bitlen+1] = {s = bitidx, l = l} end
                        bitidx = bitidx + 1
                    end
                end
                table.sort(bitlen, function(a, b) if a.l == b.l then return a.s < b.s else return a.l < b.l end end)
                bitlen[1].c = 0
                for j = 2, #bitlen do bitlen[j].c = bit32_lshift(bitlen[j-1].c + 1, bitlen[j].l - bitlen[j-1].l) end
                codetree = {}
                for j = 1, #bitlen do
                    local c, node = bitlen[j].c, codetree
                    for k = bitlen[j].l - 1, 1, -1 do
                        local n = bit32_extract(c, k, 1)
                        if not node[n+1] then node[n+1] = {} end
                        node = node[n+1]
                    end
                    node[bit32_extract(c, 0, 1)+1] = bitlen[j].s
                end
            elseif readbits(1) == 1 then
                codetree = readbits(5)
            end
            local mylz = {}
            for _, v in ipairs(ansdata) do
                if string_match(v, "^:repeat") then
                    local lencode = tonumber(string_match(v, "^:repeat(%d+)"))
                    local ebits = math_max(math_floor(lencode / 2) - 1, 0)
                    if ebits > 0 then lencode = bit32.bor(readbits(ebits), bit32_lshift(bit32_band(lencode, 1) + 2, ebits)) + 3
                    else lencode = lencode + 3 end
                    local node, distcode = codetree
                    while type(node) == "table" do node = node[readbits(1)+1] end
                    ebits = math_max(math_floor(node / 2) - 1, 0)
                    if ebits > 0 then distcode = bit32.bor(readbits(ebits), bit32_lshift(bit32_band(node, 1) + 2, ebits)) + 1
                    else distcode = node + 1 end
                    mylz[#mylz+1] = {distcode, lencode}
                end
                retval[#retval+1] = v
            end
            for _, v in ipairs(lzcodes) do mylz[#mylz+1] = v end
            lzcodes = mylz
        end
        for _, v in ipairs(combined) do retval[#retval+1] = v end
        combined = retval
        readbits()
    until readbits(1) == 1
    local retval, lzpos = {}, 1
    for _, v in ipairs(combined) do
        if string.match(v, "^:repeat") then
            local distcode, lencode = lzcodes[lzpos][1], lzcodes[lzpos][2]
            for _ = 1, lencode do retval[#retval+1] = retval[#retval-distcode+1] end
            lzpos = lzpos + 1
        else retval[#retval+1] = v end
    end
    return retval
end

local function varint(readbits)
    local num = 0
    repeat
        local n = readbits(8)
        num = num * 128 + n % 128
    until n < 128
    return num
end

local function number(readbits)
    local type = readbits(2)
    if type >= 2 then
        local esign, e = readbits(1), 0
        repeat
            local n = readbits(4)
            e = bit32_lshift(e, 3) + bit32_band(n, 7)
        until n < 8
        if esign == 1 then e = -e end
        return math.ldexp(varint(readbits) / 0x20000000000000 + 0.5, e) * (type == 2 and 1 or -1)
    else
        return varint(readbits) * (type == 0 and 1 or -1)
    end
end

local function decompress(data)
    if data:sub(1, 5) ~= "\27LuzA" then error("invalid format", 2) end
    local readbits = makeReader(data:sub(6))
    readbits(1)
    local tokentab, tokens, partial, ptype = blockdecompress(readbits, 9, all_frequencies, tokenlut), {}
    for _, node in ipairs(tokentab) do
        if type(node) == "number" then
            partial = partial .. string.char(node)
        else
            if partial then
                if ptype == ":string" then tokens[#tokens+1] = ("%q"):format(partial):gsub("\\?\n", "\\n"):gsub("\t", "\\t"):gsub("[%z\1-\31\127-\255]", function(n) return ("\\%03d"):format(n:byte()) end)
                elseif ptype == ":name" then tokens[#tokens+1] = partial
                else tokens[#tokens+1] = tostring(number(makeReader(partial))) end
                partial, ptype = nil
            end
            if node == ":name" or node == ":string" or node == ":number" then partial, ptype = "", node
            else tokens[#tokens+1] = node end
        end
    end
    local retval, lastchar, lastdot = "", false, false
    for _, v in ipairs(tokens) do
        if (lastchar and string_match(v, "^[A-Za-z0-9_]")) or (lastdot and string_match(v, "^%.")) then retval = retval .. " " end
        retval, lastchar, lastdot = retval .. v, string_match(v, "[A-Za-z0-9_]$"), string_match(v, "%.$")
    end
    return retval
end

return decompress
