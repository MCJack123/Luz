local all_frequencies = {{0,2196,},{1,391,},{2,284,},{3,184,},{4,185,},{5,80,},{6,76,},{7,85,},{8,92,},{9,56,},{10,96,},{11,29,},{12,45,},{13,37,},{14,33,},{15,53,},{16,68,},{17,22,},{18,22,},{19,24,},{20,29,},{21,19,},{22,20,},{23,13,},{24,30,},{25,31,},{26,15,},{27,18,},{28,18,},{29,16,},{30,20,},{31,27,},{32,2954,},{33,147,},{34,133,},{35,105,},{36,79,},{37,278,},{38,40,},{39,132,},{40,280,},{41,244,},{42,100,},{43,125,},{44,252,},{45,322,},{46,575,},{47,269,},{48,330,},{49,574,},{50,643,},{51,423,},{52,298,},{53,188,},{54,196,},{55,128,},{56,162,},{57,106,},{58,239,},{59,50,},{60,118,},{61,132,},{62,127,},{63,74,},{64,792,},{65,584,},{66,362,},{67,884,},{68,490,},{69,605,},{70,416,},{71,292,},{72,279,},{73,609,},{74,67,},{75,149,},{76,457,},{77,337,},{78,468,},{79,482,},{80,563,},{81,52,},{82,544,},{83,968,},{84,842,},{85,268,},{86,231,},{87,257,},{88,145,},{89,202,},{90,101,},{91,190,},{92,224,},{93,187,},{94,96,},{95,2407,},{96,34,},{97,6075,},{98,2091,},{99,3396,},{100,3133,},{101,9234,},{102,1927,},{103,1904,},{104,1900,},{105,5636,},{106,325,},{107,1067,},{108,4569,},{109,2449,},{110,5236,},{111,5309,},{112,2861,},{113,269,},{114,6252,},{115,5512,},{116,6919,},{117,3088,},{118,1292,},{119,1083,},{120,1148,},{121,1525,},{122,327,},{123,37,},{124,26,},{125,37,},{126,42,},{127,18,},{128,632,},{129,12,},{130,7,},{131,12,},{132,9,},{133,10,},{134,4,},{135,15,},{136,5,},{137,4,},{138,1,},{139,4,},{140,5,},{141,7,},{142,3,},{143,5,},{144,5,},{145,4,},{146,2,},{147,9,},{148,5,},{149,9,},{150,1,},{151,4,},{152,4,},{153,23,},{154,5,},{155,7,},{156,5,},{157,2,},{158,4,},{159,3,},{160,31,},{161,4,},{162,6,},{163,9,},{164,3,},{165,6,},{166,1,},{167,11,},{168,6,},{169,6,},{170,3,},{171,6,},{172,5,},{173,4,},{174,4,},{175,5,},{176,10,},{177,3,},{178,5,},{179,3,},{180,6,},{181,6,},{182,3,},{183,4,},{184,3,},{185,7,},{186,3,},{187,4,},{188,6,},{189,10,},{190,5,},{191,4,},{192,522,},{193,4,},{194,4,},{195,4,},{196,5,},{197,3,},{198,4,},{199,3,},{200,4,},{201,5,},{202,2,},{203,3,},{204,10,},{205,31,},{206,7,},{207,2,},{208,5,},{209,4,},{210,3,},{211,7,},{212,4,},{213,7,},{214,4,},{215,4,},{216,2,},{217,2,},{218,19,},{219,3,},{220,8,},{221,3,},{222,4,},{223,63,},{224,8,},{225,3,},{226,3,},{227,2,},{228,3,},{229,4,},{230,3,},{231,2,},{232,3,},{233,5,},{234,4,},{235,2,},{236,5,},{237,4,},{238,4,},{239,4,},{240,6,},{241,3,},{242,5,},{243,2,},{244,3,},{245,6,},{246,3,},{247,4,},{248,4,},{249,4,},{250,3,},{251,3,},{252,2,},{253,6,},{254,2,},{255,107,},{":repeat0",19920,},{":repeat1",11280,},{":repeat2",8208,},{":repeat3",6825,},{":repeat4",10747,},{":repeat5",6992,},{":repeat6",8452,},{":repeat7",4751,},{":repeat8",4482,},{":repeat9",1849,},{":repeat10",1405,},{":repeat11",582,},{":repeat12",497,},{":repeat13",532,},{"\"\"",225,},{"\"boolean\"",26,},{"\"function\"",36,},{"\"nil\"",34,},{"\"number\"",65,},{"\"r\"",34,},{"\"string\"",83,},{"\"table\"",73,},{"\"w\"",28,},{"#",323,},{"%",135,},{"(",3432,},{")",5291,},{"*",298,},{"+",794,},{",",4026,},{"-",641,},{"-1",87,},{".",1430,},{"..",617,},{"...",204,},{"/",233,},{"0",301,},{"1",292,},{"2",268,},{":",377,},{":name",7795,},{":number",1418,},{":string",2055,},{";",144,},{"<",271,},{"<=",109,},{"=",3840,},{"==",1085,},{">",309,},{">=",154,},{"[",939,},{"]",1178,},{"^",41,},{"_",104,},{"_ENV",17,},{"_G",34,},{"__call",14,},{"__index",39,},{"__newindex",12,},{"and",664,},{"bit32",37,},{"break",106,},{"close",65,},{"coroutine",29,},{"debug",22,},{"do",809,},{"else",701,},{"elseif",331,},{"end",3172,},{"error",152,},{"false",322,},{"find",66,},{"for",506,},{"function",678,},{"getmetatable",31,},{"gsub",49,},{"if",1549,},{"in",237,},{"io",24,},{"ipairs",82,},{"load",20,},{"local",2127,},{"match",43,},{"math",114,},{"nil",742,},{"not",340,},{"open",54,},{"or",690,},{"os",93,},{"package",12,},{"pairs",107,},{"pcall",35,},{"print",87,},{"read",43,},{"repeat",34,},{"require",46,},{"return",1326,},{"select",33,},{"self",101,},{"setmetatable",76,},{"string",139,},{"sub",108,},{"table",135,},{"then",1807,},{"tonumber",45,},{"tostring",55,},{"true",433,},{"type",147,},{"unpack",65,},{"until",29,},{"while",209,},{"write",80,},{"{",845,},{"}",930,},{"~=",525,},R=18,}
local bit32_band, bit32_rshift, bit32_lshift, bit32_extract, math_frexp, math_max, math_floor, string_match = bit32.band, bit32.rshift, bit32.lshift, bit32.extract, math.frexp, math.max, math.floor, string.match
local function log2(n) local _, r = math_frexp(n) return r-1 end
local tokenlut, rlemap = {}, {2, 6, 22, 86, 342, 1366, 5462}
for i, v in ipairs(all_frequencies) do tokenlut[i] = v[1] end

local function makeReader(str)
    local partial, bits, pos = 0, 0, 1
    local function readbits(n)
        if n == 0 then return 0 end
        while bits < n do partial, pos, bits = bit32_lshift(partial, 8) + str:byte(pos), pos + 1, bits + 8 end
        local retval = bit32_band(bit32_rshift(partial, bits-n), 2^n-1)
        bits = bits - n
        return retval
    end
    return readbits
end

local function generateDecodeTable(Ls)
    local R = Ls.R
    local L = 2^R
    local X, step = 0, 0.625 * L + 3
    local decodingTable, next, symbol = {R = R}, {}, {}
    for _, p in ipairs(Ls) do
        next[p[1]] = p[2]
        for _ = 1, p[2] do symbol[X], X = p[1], (X + step) % L end
    end
    for X = 0, L - 1 do
        local s = symbol[X]
        local t = {symbol = s, nbBits = R - log2(next[s])}
        t.newX, decodingTable[X], next[s] = bit32_lshift(next[s], t.nbBits) - L, t, next[s] + 1
    end
    return decodingTable
end

local function ansdecode(readbits, nsym, decodingTable)
    local X, retval = readbits(decodingTable.R), {}
    for i = 1, nsym do
        local t = decodingTable[X]
        retval[#retval+1], X = t.symbol, t.newX + readbits(t.nbBits)
    end
    return retval
end

local function blockdecompress(readbits, nBits, defaultLs, symbolMap)
    local combined, lzcodes = {}, {}
    repeat
        local retval = {}
        if readbits(1) == 0 then
            local bits, nEntries = readbits(3)
            if bits == 0 then nEntries = 1
            else nEntries = readbits(bits * 2) + rlemap[bits] end
            for _ = 1, nEntries do
                local n, c = readbits(4), readbits(nBits)
                for _ = 0, n do retval[#retval+1] = symbolMap[c] end
            end
        else
            local Ls
            if readbits(1) == 1 then
                if readbits(1) == 1 then
                    local R, maxL, numEnt = readbits(4) + 5, readbits(4) + 5, readbits(nBits)
                    Ls = {R = R}
                    local totalL, lastn = 2^R - 1, -1
                    for _ = 1, numEnt do
                        local _, e, sym = math_frexp(totalL)
                        local nbits, n = math.min(e, maxL)
                        if readbits(1) == 1 then sym = readbits(nBits)
                        else sym = lastn + 1 end
                        if readbits(1) == 1 then n = readbits(nbits)
                        else n = readbits(math.floor(nbits/2)) end
                        Ls[#Ls+1], totalL, lastn = {symbolMap[sym], n}, totalL - n, sym
                    end
                else
                    local bitlen, bitidx, maxs = {}, 0, readbits(9)
                    while bitidx <= maxs do
                        if readbits(1) == 1 then
                            local n, c = readbits(3) + 2, readbits(5)
                            for _ = 1, n do
                                if c > 0 then bitlen[#bitlen+1] = {symbolMap[bitidx], 2^(R-c)} end
                                bitidx = bitidx + 1
                            end
                        else
                            local l = readbits(5)
                            if l > 0 then bitlen[#bitlen+1] = {symbolMap[bitidx], 2^(R-l)} end
                            bitidx = bitidx + 1
                        end
                    end
                    Ls = bitlen
                end
            else
                if not defaultLs then error("invalid file (dictionary required but not supplied)", 2) end
                Ls = defaultLs
            end
            local decodingTable, anssyms = generateDecodeTable(Ls), readbits(18)
            local ansdata, codetree = ansdecode(readbits, anssyms, decodingTable)
            if readbits(1) == 1 then
                local bitlen, bitidx = {}, 0
                while bitidx < 30 do
                    if readbits(1) == 1 then
                        local n, c = readbits(3) + 2, readbits(4)
                        for _ = 1, n do
                            if c > 0 then bitlen[#bitlen+1] = {s = bitidx, l = c} end
                            bitidx = bitidx + 1
                        end
                    else
                        local l = readbits(4)
                        if l > 0 then bitlen[#bitlen+1] = {s = bitidx, l = l} end
                        bitidx = bitidx + 1
                    end
                end
                table.sort(bitlen, function(a, b) if a.l == b.l then return a.s < b.s else return a.l < b.l end end)
                bitlen[1].c = 0
                for j = 2, #bitlen do bitlen[j].c = bit32_lshift(bitlen[j-1].c + 1, bitlen[j].l - bitlen[j-1].l) end
                codetree = {}
                for j = 1, #bitlen do
                    local c, node = bitlen[j].c, codetree
                    for k = bitlen[j].l - 1, 1, -1 do
                        local n = bit32_extract(c, k, 1)
                        if not node[n+1] then node[n+1] = {} end
                        node = node[n+1]
                    end
                    node[bit32_extract(c, 0, 1)+1] = bitlen[j].s
                end
            elseif readbits(1) == 1 then
                codetree = readbits(5)
            end
            local mylz = {}
            for _, v in ipairs(ansdata) do
                if string_match(v, "^:repeat") then
                    local lencode = tonumber(string_match(v, "^:repeat(%d+)"))
                    local ebits = math_max(math_floor(lencode / 2) - 1, 0)
                    if ebits > 0 then lencode = bit32.bor(readbits(ebits), bit32_lshift(bit32_band(lencode, 1) + 2, ebits)) + 3
                    else lencode = lencode + 3 end
                    local node, distcode = codetree
                    while type(node) == "table" do node = node[readbits(1)+1] end
                    ebits = math_max(math_floor(node / 2) - 1, 0)
                    if ebits > 0 then distcode = bit32.bor(readbits(ebits), bit32_lshift(bit32_band(node, 1) + 2, ebits)) + 1
                    else distcode = node + 1 end
                    mylz[#mylz+1] = {distcode, lencode}
                end
                retval[#retval+1] = v
            end
            for _, v in ipairs(lzcodes) do mylz[#mylz+1] = v end
            lzcodes = mylz
        end
        for _, v in ipairs(combined) do retval[#retval+1] = v end
        combined = retval
        readbits()
    until readbits(1) == 1
    local retval, lzpos = {}, 1
    for _, v in ipairs(combined) do
        if string.match(v, "^:repeat") then
            local distcode, lencode = lzcodes[lzpos][1], lzcodes[lzpos][2]
            for _ = 1, lencode do retval[#retval+1] = retval[#retval-distcode+1] end
            lzpos = lzpos + 1
        else retval[#retval+1] = v end
    end
    return retval
end

local function varint(readbits)
    local num = 0
    repeat
        local n = readbits(8)
        num = num * 128 + n % 128
    until n < 128
    return num
end

local function number(readbits)
    local type = readbits(2)
    if type >= 2 then
        local esign, e = readbits(1), 0
        repeat
            local n = readbits(4)
            e = bit32_lshift(e, 3) + bit32_band(n, 7)
        until n < 8
        if esign == 1 then e = -e end
        return math.ldexp(varint(readbits) / 0x20000000000000 + 0.5, e) * (type == 2 and 1 or -1)
    else
        return varint(readbits) * (type == 0 and 1 or -1)
    end
end

local function decompress(data)
    if data:sub(1, 5) ~= "\27LuzA" then error("invalid format", 2) end
    local readbits = makeReader(data:sub(6))
    readbits(1)
    local tokentab, tokens, partial, ptype = blockdecompress(readbits, 9, all_frequencies, tokenlut), {}
    for _, node in ipairs(tokentab) do
        if type(node) == "number" then
            partial = partial .. string.char(node)
        else
            if partial then
                if ptype == ":string" then tokens[#tokens+1] = ("%q"):format(partial):gsub("\\?\n", "\\n"):gsub("\t", "\\t"):gsub("[%z\1-\31\127-\255]", function(n) return ("\\%03d"):format(n:byte()) end)
                elseif ptype == ":name" then tokens[#tokens+1] = partial
                else tokens[#tokens+1] = tostring(number(makeReader(partial))) end
                partial, ptype = nil
            end
            if node == ":name" or node == ":string" or node == ":number" then partial, ptype = "", node
            else tokens[#tokens+1] = node end
        end
    end
    local retval, lastchar, lastdot = "", false, false
    for _, v in ipairs(tokens) do
        if (lastchar and string_match(v, "^[A-Za-z0-9_]")) or (lastdot and string_match(v, "^%.")) then retval = retval .. " " end
        retval, lastchar, lastdot = retval .. v, string_match(v, "[A-Za-z0-9_]$"), string_match(v, "%.$")
    end
    return retval
end

return decompress
